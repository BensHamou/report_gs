<div class="modal fade" id="printModal" tabindex="-1" role="dialog" aria-labelledby="printModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="printModalLabel">Imprimer l'Étiquette</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body print-modal text-center">
                <div id="qr-code-section" class="mb-4">
                    <img id="qr-code-image" src="" alt="QR Code" style="max-width: 40%; height: auto;" crossOrigin="anonymous">
                </div>

                <div class="row">
                    <div class="col-md-6 text-left">
                        <p class="text-muted m-0">Produit:</p>
                        <strong class="text-dark" id="modal-product-name"></strong>
                    </div>
                    <div class="col-md-6 text-left">
                        <p class="text-muted m-0">Date Expiration:</p>
                        <strong class="text-dark" id="modal-expiry-date"></strong>
                        <p class="text-muted m-0 mt-2">Date Production:</p>
                        <strong class="text-dark" id="modal-production-date"></strong>
                    </div>
                    <div class="col-md-6 text-left mt-5">
                        <p class="text-muted m-0">N° Lot:</p>
                        <strong class="text-dark" id="modal-lot-number"></strong>
                        <p class="text-muted m-0 mt-1">Shift:</p>
                        <strong class="text-dark" id="modal-shift"></strong>
                    </div>
                    <div class="col-md-3 text-left mt-5">
                        <p class="text-muted m-0">Magasin:</p>
                        <strong class="text-dark" id="modal-magasin"></strong>
                    </div>
                    <div class="col-md-3 text-left mt-5">
                        <p class="text-muted m-0">Emplacement:</p>
                        <strong class="text-dark" id="modal-emplacement"></strong>
                    </div>
                </div>
            </div>
            <div class="row text-center">
                <div class="mt-5 mb-2">
                    <label for="ticket-count">Nombre d'étiquettes:</label>
                    <input type="number" id="ticket-count" class="form-control w-50 mx-auto" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="print-button">Imprimer</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('print-button').addEventListener('click', function () {
        const ticketCount = parseInt(document.getElementById('ticket-count').value) || 1;
        const qrCodeImage = document.getElementById('qr-code-image');
        const img = new Image();

        img.crossOrigin = "Anonymous";
        img.src = qrCodeImage.src;

        img.onload = function() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            context.drawImage(img, 0, 0);
            const base64Image = canvas.toDataURL('image/png');
            const printWindow = window.open('', '_blank');

            if (printWindow) {
                let printContent = '';
                for (let i = 0; i < ticketCount; i++) {
                    printContent += `
                    <div class="label">
                        <img src="${base64Image}" alt="QR Code">
                        <div class="product-name">${document.getElementById('modal-product-name').textContent}</div>
                    </div>`;
                }
                
                printWindow.document.open();
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Étiquette de Palette GrupoPuma</title>
                        <style>
                            @page {
                                size: 50cm 40cm;
                                margin: 0;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                                width: 50cm;
                                height: 40cm;
                                font-family: Arial, sans-serif;
                            }
                            .label {
                                width: 20cm;
                                height: 15cm;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                                align-items: center;
                                margin: 1cm;
                                border: 1px solid #ccc;
                                page-break-after: always;
                            }
                            img {
                                max-width: 80%;
                                max-height: 70%;
                                object-fit: contain;
                                margin-bottom: 10px;
                            }
                            .product-name {
                                font-size: 2.5rem;
                                font-weight: bold;
                                text-align: center;
                            }
                        </style>
                    </head>
                    <body>${printContent}</body>
                    </html>
                `);
                printWindow.document.close();

                setTimeout(() => {
                    printWindow.print();
                    printWindow.onafterprint = () => printWindow.close();
                }, 500);
                
            } else {
                alert("Erreur! Veuillez autoriser les popups pour continuer.");
            }
        };
        img.onerror = function() {
            alert("Erreur lors du chargement de l'image QR.  Veuillez réessayer.");
        };
    });
</script>
